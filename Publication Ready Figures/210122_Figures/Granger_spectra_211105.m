%% Close all figures, clear variables and command window
close all
clear
clc

%% Paths
strPaths.Main = 'F:\Vasileios\';
strPaths.Project = [strPaths.Main, 'Task Analysis\'];
strPaths.GeneralFunctions = 'F:\Vasileios\Task Analysis\Code\';
strPaths.Data = [strPaths.Main, 'Task Analysis\Data\'];
strPaths.ExtractedData = [strPaths.Main, 'Task Analysis\Extracted_Data Sternberg\'];
strPaths.Statistics = [strPaths.Main, 'Task Analysis\Code\Statistics\'];
strPaths.ChanLoc = [strPaths.Main, 'Task Analysis\Code\Channel Localization\'];
strPaths.EEGLAB_Subfunctions = [strPaths.Main,'Task Analysis\Code\Subfunctions\EEGLAB Subfunctions\'];
strPaths.Subfunctions = [strPaths.Main,'Task Analysis\Code\Subfunctions\']
strPaths.FigureData = [strPaths.Data,'Analysis Data\Figure Data\'];
% Results
strPaths.Results = [strPaths.Main,'Task Analysis\Analysis Results\'];

% FieldTrip toolbox
% strPaths.Toolboxes.FieldTrip            = 'F:\Vasileios\Toolboxes\fieldtrip-20191126\';
strPaths.Toolboxes.FieldTrip            = 'F:\Vasileios\Toolboxes\fieldtrip-20200315\';

% EEGLAB toolbox
strPaths.Toolboxes.EEGLAB               = 'F:\Vasileios\Toolboxes\eeglab14_1_1b\';

% Change main directory
cd(strPaths.Main)

% Add all subfolders to path
addpath(strPaths.Main)
addpath(strPaths.Project)
addpath(genpath(strPaths.GeneralFunctions))
addpath(strPaths.Data)
addpath(strPaths.ExtractedData)
addpath(strPaths.Statistics)
addpath(strPaths.ChanLoc)
addpath(strPaths.Subfunctions)
addpath(strPaths.EEGLAB_Subfunctions)
addpath(strPaths.Results)
addpath(strPaths.Toolboxes.FieldTrip)
% Remove EEGLAB from path

% rmpath(genpath(strPaths.Toolboxes.EEGLAB))


% Plot colors
strPlotColors = {'b','g','r','c','k','m'};
ft_defaults

%Add figure tools on toolbar
set(groot,'defaultFigureCreateFcn',@(fig,~)addToolbarExplorationButtons(fig))
set(groot,'defaultAxesCreateFcn',@(ax,~)set(ax.Toolbar,'Visible','off'))
%% Figure Data
strPaths.FigureVars = [strPaths.FigureData,'210122 Granger_spectra\Granger_spectra_Fig.mat'];
load(strPaths.FigureVars)

%% Initialize variables
Colors = Granger_Spectra_Fig.colors;
Colors{1} ='b';
Colors{2} = [0.30,0.75,0.93];
freq_ax = Granger_Spectra_Fig.freqAxis2;
xlimit = [4 20]%Granger_Spectra_Fig.ylim;
SubjGranger_spectra = Granger_Spectra_Fig.spectra_recalculated_2; 
CortexHipp_Enc_Mean = Granger_Spectra_Fig.MeanSpectra.CortexHipp_Enc;
HippCortex_Enc_Mean = Granger_Spectra_Fig.MeanSpectra.HippCortex_Enc;
HippCortex_Maint_Mean = Granger_Spectra_Fig.MeanSpectra.HippCortex_Maint;
CortexHipp_Maint_Mean = Granger_Spectra_Fig.MeanSpectra.CortexHipp_Maint;
Percentiles_per_Patient_enc = Granger_Spectra_Fig.Percentile_enc_2;
Percentiles_per_Patient_maint = Granger_Spectra_Fig.Percentile_maint_2;

%% Make Figure
fig = figure;
set(fig,'Units', 'centimeters')
% set(fig,'Position',[8.440208333333334,3.01625,20.21416666666667,22.11916666666667]);%[4.8948,2.8581,19,20]);
h=gcf;

set(fig,'Position',[9.048750000000004,9.657291666666667,19.685000000000002,15.478125000000004]);

ha = tight_subplot(3,5,[.1 .08],[.12 .04],[.08, .05])%tight_subplot(3,5,[.09 .09],[.07 .07],[.1 .09])%[0.05 0.05],[.1 .05],[.1 .1])%[0.05 0.03],[0.05 0.05])
set(ha(1:size(ha,1)),'Fontsize',20)
order = [11 12 13 4 6 1 5 2 3 14 9 7 15 10 8 ];%[1:15];%

%% Visualization
for i =1:length(SubjGranger_spectra)
    
    CortexHipp_Enc = SubjGranger_spectra{order(i)}.Enc.grangerspctrm(1,:);
    HippCortex_Enc = SubjGranger_spectra{order(i)}.Enc.grangerspctrm(2,:);
    HippCortex_Maint = SubjGranger_spectra{order(i)}.Maint.grangerspctrm(1,:);
    CortexHipp_Maint = SubjGranger_spectra{order(i)}.Maint.grangerspctrm(2,:);
    %
    %% Plot the spectra
    axes(ha(i));
    semilogx(freq_ax, SubjGranger_spectra{order(i)}.Enc.grangerspctrm(1,:)*100,'Color',Colors{1},'LineWidth',2);
    hold on;
    semilogx(freq_ax, SubjGranger_spectra{order(i)}.Enc.grangerspctrm(2,:)*100,'Color',Colors{2},'LineWidth',2);
    semilogx(freq_ax, SubjGranger_spectra{order(i)}.Maint.grangerspctrm(1,:)*100,'Color',Colors{3},'LineWidth',2);
    semilogx(freq_ax, SubjGranger_spectra{order(i)}.Maint.grangerspctrm(2,:)*100,'Color',Colors{4},'LineWidth',2);
    
    %% align the spectra among the panels
    maxPeak = max(max(CortexHipp_Enc),max(HippCortex_Maint))*100;
    minPeak = min(min(CortexHipp_Enc),min(HippCortex_Maint))*100;
    ylimit = [minPeak-(1/3*(maxPeak)) (1/3*(maxPeak))+maxPeak];
    ylim([ylimit(1) ylimit(2)]);
    xlim([xlimit(1) xlimit(2)]);
    
    ylab(i) = ylabel('Granger (%)');
    xlabel('Frequency (Hz)');
    
    %% align the significance bars
    indMaxBandCortexHipp_Enc = Difference_Bar(CortexHipp_Enc-HippCortex_Enc,Percentiles_per_Patient_enc{order(i),95},...
        freq_ax,[0 0.2], ylimit(1)/2 ,Colors{1});%ylimit(1)+0.01
    indMaxBandHippCortex_Maint = Difference_Bar(HippCortex_Maint-CortexHipp_Maint,Percentiles_per_Patient_maint{order(i),95},...
        freq_ax,[0 0.2],  ylimit(1)/2+  ylimit(1)/5,Colors{3});
    axis square
end
% %% Mean Granger spectra
% axes(ha(length(ha)));
% semilogx(freq_ax,CortexHipp_Enc_Mean*100,'Color',Colors{1},'LineWidth',2);
% hold on;
% semilogx(freq_ax,HippCortex_Enc_Mean*100,'Color',Colors{2},'LineWidth',2);
% semilogx(freq_ax,HippCortex_Maint_Mean*100,'Color',Colors{3},'LineWidth',2);
% semilogx(freq_ax,CortexHipp_Maint_Mean*100,'Color',Colors{4},'LineWidth',2);
% xlim([xlimit(1) xlimit(2)]);
% ylab(16) = ylabel('Granger (%)');
% xlabel('Frequency (Hz)');
% 

%% Axes Properties

for i =1:length(ha)
    
    set(ha(i),'box','off','FontSize',10,'TickDir','out','XMinorTick','on', ...,
        'YMinorTick','off','TickLength',[0.04 0.025],'XTick',[4 10 20 30],'XTickLabels',[4 10 20 30])
    xlab = get(ha(i),'XLabel');
    set(xlab,'VerticalAlignment','top');
%        ytickformat(ha(i),'%.2f')
   if i == 7
       set(ha(i),'YTick',[0 4 8], 'YTickLabel',[0 4 8]);
   end
end


%% TextBoxes

textBox_FontSize = 16;
% Create textbox
annotation(fig,'textbox',...
    [0.381825986601369 0.967899522137127 0.0392670149266409 0.0322966501116754],...
    'String','c',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.579688115746232 0.967899522137127 0.0392670149266411 0.0322966501116749],...
    'String','d',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.0144682767550526 0.967899522137128 0.0392670149266408 0.032296650111675],...
    'String',{'a'},...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.0119560322017698 0.649349650955675 0.0392670149266412 0.032296650111675],...
    'String','f',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.201648088723757 0.651059052665077 0.039267014926641 0.032296650111675],...
    'String','g',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.197510274165403,0.967899522137128,0.039267014926641,0.032296650111675],...
    'String',{'b',''},...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.386069357653566 0.647640249246272 0.039267014926641 0.032296650111675],...
    'String','h',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.588252265946067 0.650627612759953 0.0392670149266409 0.0322966501116749],...
    'String','i',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.769914991836963 0.936347155768206 0.039267014926641 0.063652844231794],...
    'String','e',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.772708720373811 0.65695199013696 0.039267014926641 0.0322966501116752],...
    'String','j',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.00806451612903917 0.334388296520636 0.039267014926641 0.032296650111675],...
    'String','k',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.384197489162866 0.333273913827306 0.039267014926641 0.0322966501116748],...
    'String','m',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.577886618251422 0.333273913827305 0.0392670149266413 0.032296650111675],...
    'String','n',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.767508303777519 0.333273913827306 0.039267014926641 0.032296650111675],...
    'String','o',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.197967685638704 0.334983315536707 0.039267014926641 0.032296650111675],...
    'String','l',...
    'FontSize',textBox_FontSize,...
    'FontWeight','bold',...
    'FitBoxToText','off',...
    'EdgeColor','none');



% Create textbox
annotation(fig,'textbox',...
    [0.0766129032258066 0.91865812052417 0.0510752676956115 0.0461538452877958],...
    'String',{'T4'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.26478494623656 0.91865812052417 0.0510752676956115 0.0461538452877958],...
    'String',{'T5'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.834677419354847 0.296435898301948 0.0510752676956115 0.0461538452877958],...
    'String',{'T3'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.454301075268819 0.91865812052417 0.0510752676956116 0.0461538452877958],...
    'String',{'T6'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.643817204301078 0.91865812052417 0.0510752676956115 0.0461538452877958],...
    'String',{'T3'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.833333333333336 0.91865812052417 0.0537634396585085 0.0461538452877958],...
    'String',{'C4'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.0752688172043064 0.612675214541264 0.0510752676956115 0.0461538452877958],...
    'String',{'T3'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.262096774193553 0.612675214541264 0.0510752676956115 0.0461538452877958],...
    'String',{'T4'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.452956989247316 0.610965812831863 0.0537634396585085 0.0461538452877958],...
    'String',{'C3'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.645161290322584 0.610965812831863 0.0537634396585086 0.0461538452877958],...
    'String',{'C3'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.833333333333336 0.612675214541265 0.0537634396585085 0.0461538452877958],...
    'String',{'T3'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.0766129032258118 0.296435898301949 0.0537634396585085 0.0461538452877958],...
    'String',{'C3'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.264784946236565 0.296435898301948 0.0537634396585085 0.0461538452877958],...
    'String',{'C3'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.452956989247318 0.296435898301948 0.0510752676956115 0.0461538452877958],...
    'String',{'T4'},...
    'EdgeColor','none');

% Create textbox
annotation(fig,'textbox',...
    [0.645161290322588 0.296435898301948 0.0510752676956115 0.0461538452877958],...
    'String',{'T5'},...
    'EdgeColor','none');

% 
% for i = 1:15
%     indLab(i) = find(order==i);
% end
set(ylab(1),'Position',[1.834674141402808,1.789651830870508,-1]);
set(ylab(2),'Position',[1.763372335731407,1.125382408565043,-1]);
set(ylab(3),'Position',[1.638059204119506,0.428729760262582,-1]);
set(ylab(4),'Position',[1.789598913148435,8.4981739371854,-1]);
set(ylab(5),'Position',[1.807238713063175,6.852832951079361,-1]);
set(ylab(6),'Position',[1.834674141402808,3.955590210237087,-1]);
set(ylab(7),'Position',[1.763372335731407,3.655306393973067,-1]);
set(ylab(8),'Position',[1.638059204119506,2.027945368718917,-1]);
set(ylab(9),'Position',[1.789598913148435,1.763192266153051,-1]);
set(ylab(10),'Position',[1.807238713063175,1.623249343123992,-1]);
set(ylab(11),'Position',[1.834674141402808,1.4812,-1]);
set(ylab(12),'Position',[1.763372335731407,1.5692,-1]); %[1.663290031873078,0.739469761396654,-1]
set(ylab(13),'Position',[1.789598913148435,1.4211,-1]);
set(ylab(14),'Position',[1.789598913148435,1.383934971208354,-1]);
set(ylab(15),'Position',[1.807238713063175,0.652678579117211,-1]);
%% Save Figure
set(gcf,'color','white')
set(gcf, 'InvertHardcopy', 'off') % take into account the axes colors
mkdir('F:\Vasileios\Task Analysis\Analysis Results\Results_for_Publication\Publication Ready Figure\Portrait Figs\Granger_spectra\Revision\');
print(fig,'F:\Vasileios\Task Analysis\Analysis Results\Results_for_Publication\Publication Ready Figure\Portrait Figs\Granger_spectra\Revision\vWM Granger_spectra','-dpdf','-r1000');
print(fig,'F:\Vasileios\Task Analysis\Analysis Results\Results_for_Publication\Publication Ready Figure\Portrait Figs\Granger_spectra\Revision\vWM Granger_spectra','-dpng','-r1000');
print(fig,'F:\Vasileios\Task Analysis\Analysis Results\Results_for_Publication\Publication Ready Figure\Portrait Figs\Granger_spectra\Revision\vWM Granger_spectra','-depsc','-r1000');
saveas(fig,'F:\Vasileios\Task Analysis\Analysis Results\Results_for_Publication\Publication Ready Figure\Portrait Figs\Granger_spectra\Revision\vWM Granger_spectra.fig');
saveas(fig,'F:\Vasileios\Task Analysis\Analysis Results\Results_for_Publication\Publication Ready Figure\Portrait Figs\Granger_spectra\Revision\vWM Granger_spectra.tiff');

